<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js æ‰‹åŠ¿äº¤äº’ç²’å­ç³»ç»Ÿ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        /* æ‘„åƒå¤´é¢„è§ˆ (é»˜è®¤éšè—ï¼Œè°ƒè¯•æ—¶å¯å¼€å¯) */
        #video-feed {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 160px;
            height: 120px;
            border-radius: 8px;
            opacity: 0.5;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 10;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            pointer-events: none;
            transition: opacity 0.5s;
            text-align: center;
        }
        
        /* å…¨å±æŒ‰é’® */
        #fs-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            z-index: 100;
        }
        #fs-btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            bottom: 70px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            font-size: 14px;
            bottom: 100px; /* æŠ¬é«˜ä½ç½®ç»™åº•éƒ¨ Dock è®©ä½ */
        }

        /* åº•éƒ¨ç»ç’ƒæ‹Ÿæ€ Dock */
        .glass-dock {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .glass-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.05);
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .glass-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: rgba(255,255,255,0.3);
        }

        .glass-btn:hover::before {
            opacity: 1;
        }

        .glass-btn.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.3), inset 0 0 0 1px rgba(255,255,255,0.4);
            transform: translateY(-2px);
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .glass-btn:active {
            transform: scale(0.95);
        }
    </style>
    <script src="../home-button.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.18.0/dist/lil-gui.esm.min.js",
                "@mediapipe/hands": "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js",
                "@mediapipe/camera_utils": "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loader">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...<br><span style="font-size:14px; opacity:0.7">è¯·å…è®¸æ‘„åƒå¤´æƒé™</span></div>
    <video id="video-feed" playsinline></video>
    <button id="fs-btn">â›¶ å…¨å±ä½“éªŒ</button>
    <div class="instruction">å¼ å¼€åŒæ‰‹å¯æ‰©æ•£ç²’å­ï¼ŒæåˆåŒæ‰‹å¯èšé›†ç²’å­</div>

    <div class="glass-dock" id="shape-dock">
        <button class="glass-btn active" data-shape="heart" title="çˆ±å¿ƒ">â¤ï¸</button>
        <button class="glass-btn" data-shape="saturn" title="åœŸæ˜Ÿ">ğŸª</button>
        <button class="glass-btn" data-shape="flower" title="èŠ±æœµ">ğŸŒ¸</button>
        <button class="glass-btn" data-shape="fireworks" title="çƒŸèŠ±">ğŸ†</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, particles, geometry, materials;
        let handLandmarker;
        let targetPositions = []; // å­˜å‚¨ç›®æ ‡å½¢çŠ¶çš„åæ ‡
        let currentPositions; // å½“å‰ç²’å­åæ ‡
        const PARTICLE_COUNT = 15000;
        const PARTICLE_SIZE = 0.08;
        
        // äº¤äº’çŠ¶æ€
        const state = {
            shape: 'heart', // é»˜è®¤å½¢çŠ¶
            color: '#ff0055',
            handDistance: 0, // æ‰‹åŠ¿æ§åˆ¶å› å­ (0-1)
            smoothing: 0.1, // åŠ¨ç”»å¹³æ»‘åº¦
            autoRotate: true
        };

        // å½¢çŠ¶ç”Ÿæˆå‡½æ•°é›†åˆ
        const shapes = {
            // çˆ±å¿ƒ
            heart: (i) => {
                const x = THREE.MathUtils.randFloatSpread(2);
                const y = THREE.MathUtils.randFloatSpread(2);
                const z = THREE.MathUtils.randFloatSpread(2);
                // æ‹’ç»é‡‡æ ·æ³•åœ¨çƒä½“å†…ç”Ÿæˆï¼Œç„¶åæ˜ å°„åˆ°çˆ±å¿ƒå…¬å¼
                const phi = Math.random() * Math.PI * 2;
                const theta = Math.random() * Math.PI;
                const r = 10 * Math.pow(Math.sin(theta), 0.5); // åˆ†æ•£ä¸€ç‚¹
                
                // 3D Heart Formula
                // x = 16sin^3(t)
                // y = 13cos(t) - 5cos(2t) - 2cos(3t) - cos(4t)
                // z = varied for thickness
                
                // è¿™é‡Œä½¿ç”¨ä¸€ç§å‚æ•°æ–¹ç¨‹å˜ä½“ç”Ÿæˆä½“ç§¯çˆ±å¿ƒ
                const t = Math.random() * Math.PI * 2;
                const u = Math.random() * Math.PI;
                
                // åŸºç¡€å½¢çŠ¶
                let px = 16 * Math.pow(Math.sin(t), 3);
                let py = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                let pz = 8 * Math.cos(u) * Math.sin(t); // å¢åŠ åšåº¦è®©ä¸­é—´æ›´é¥±æ»¡

                // æ·»åŠ éšæœºæ€§å¡«å……å†…éƒ¨
                // ä½¿ç”¨ç«‹æ–¹æ ¹è®©ç²’å­åˆ†å¸ƒæ›´å‡åŒ€ï¼Œé¿å…ä¸­å¿ƒè¿‡äºå¯†é›†ï¼Œçœ‹èµ·æ¥æ›´"å®"
                const scale = Math.cbrt(Math.random()); 
                return new THREE.Vector3(px * scale * 0.2, py * scale * 0.2, pz * scale * 0.2);
            },
            // åœŸæ˜Ÿ
            saturn: (i) => {
                const isRing = Math.random() > 0.6; // 40% æ˜¯ç¯
                if (isRing) {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = THREE.MathUtils.randFloat(4, 7);
                    return new THREE.Vector3(Math.cos(angle) * radius, Math.random() * 0.2, Math.sin(angle) * radius);
                } else {
                    // ä¸»ä½“çƒ
                    const u = Math.random();
                    const v = Math.random();
                    const theta = 2 * Math.PI * u;
                    const phi = Math.acos(2 * v - 1);
                    const r = 2.5;
                    return new THREE.Vector3(
                        r * Math.sin(phi) * Math.cos(theta),
                        r * Math.sin(phi) * Math.sin(theta),
                        r * Math.cos(phi)
                    );
                }
            },
            // èŠ±æœµ
            flower: (i) => {
                const u = Math.random() * Math.PI * 2;
                const v = Math.random() * Math.PI;
                const r = 3 + Math.sin(5 * u) * Math.sin(5 * v); // ç®€å•çš„èŠ±ç“£æ³¢çº¹
                
                return new THREE.Vector3(
                    r * Math.sin(v) * Math.cos(u),
                    r * Math.sin(v) * Math.sin(u),
                    r * Math.cos(v)
                );
            },
            // çƒŸèŠ±/çƒä½“
            fireworks: (i) => {
                 const u = Math.random();
                 const v = Math.random();
                 const theta = 2 * Math.PI * u;
                 const phi = Math.acos(2 * v - 1);
                 const r = 5 + Math.random() * 2; // æ‰©æ•£çš„çƒä½“
                 return new THREE.Vector3(
                     r * Math.sin(phi) * Math.cos(theta),
                     r * Math.sin(phi) * Math.sin(theta),
                     r * Math.cos(phi)
                 );
            }
        };

        // --- åˆå§‹åŒ– Three.js ---
        function initThree() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();
            // æ·»åŠ ä¸€äº›ç¯å¢ƒé›¾ï¼Œå¢åŠ æ·±é‚ƒæ„Ÿ
            scene.fog = new THREE.FogExp2(0x050505, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 15;
            camera.position.y = 5;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = state.autoRotate;
            controls.autoRotateSpeed = 2.0;

            // åˆ›å»ºç²’å­
            geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            currentPositions = new Float32Array(PARTICLE_COUNT * 3);
            
            // åˆå§‹åŒ–ä½ç½®
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 50;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 50;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 50;
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            // æè´¨
            const textureLoader = new THREE.TextureLoader();
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„åœ†å½¢è¾‰å…‰è´´å›¾
            const sprite = textureLoader.load('https://threejs.org/examples/textures/sprites/disc.png');

            materials = new THREE.PointsMaterial({
                size: PARTICLE_SIZE,
                color: new THREE.Color(state.color),
                map: sprite,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true,
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            particles = new THREE.Points(geometry, materials);
            scene.add(particles);

            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªå½¢çŠ¶
            calculateTargetShape(state.shape);

            // UI è®¾ç½®
            setupUI(controls);
            
            // å…¨å±æŒ‰é’®
            document.getElementById('fs-btn').addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            });

            window.addEventListener('resize', onWindowResize);
            animate(controls);
        }

        function setupUI(controls) {
            const gui = new GUI({ title: 'æ§åˆ¶é¢æ¿' });
            
            // ç§»é™¤æ—§çš„ä¸‹æ‹‰æ¡†ï¼Œæ”¹ç”¨åº•éƒ¨ Dock æ§åˆ¶
            // gui.add(state, 'shape', Object.keys(shapes))...
            
            gui.addColor(state, 'color').name('ç²’å­é¢œè‰²').onChange(val => {
                materials.color.set(val);
            });

            gui.add(state, 'autoRotate').name('è‡ªåŠ¨æ—‹è½¬').onChange(val => {
                controls.autoRotate = val;
            });

            // ç»‘å®š Dock æŒ‰é’®äº‹ä»¶
            const buttons = document.querySelectorAll('.glass-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
                    buttons.forEach(b => b.classList.remove('active'));
                    
                    // æ¿€æ´»å½“å‰æŒ‰é’®
                    const target = e.currentTarget;
                    target.classList.add('active');
                    
                    // åˆ‡æ¢å½¢çŠ¶
                    const shape = target.dataset.shape;
                    if (shapes[shape]) {
                        state.shape = shape;
                        calculateTargetShape(shape);
                    }
                });
            });
        }

        // --- æ ¸å¿ƒæ•°å­¦ï¼šè®¡ç®—ç›®æ ‡å½¢çŠ¶åæ ‡ ---
        function calculateTargetShape(shapeName) {
            targetPositions = [];
            const func = shapes[shapeName];
            
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const vec = func(i);
                targetPositions.push(vec.x, vec.y, vec.z);
            }
        }

        // --- åŠ¨ç”»å¾ªç¯ ---
        function animate(controls) {
            requestAnimationFrame(() => animate(controls));

            const positions = particles.geometry.attributes.position.array;

            // äº¤äº’é€»è¾‘ï¼šæ‰‹åŠ¿è·ç¦»å½±å“æ‰©æ•£
            // handDistance: 0 (æ­£å¸¸) -> 1 (æåº¦æ‰©æ•£)
            // æˆ‘ä»¬ç”¨ä¸€ä¸ª factor æ¥æ§åˆ¶è¿™ä¸ªæ”¾å¤§å€æ•°
            const expansionFactor = 1 + (state.handDistance * 3.0); // æœ€å¤§æ”¾å¤§4å€

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const idx = i * 3;
                
                // ç›®æ ‡ä½ç½®
                const tx = targetPositions[idx] * expansionFactor;
                const ty = targetPositions[idx + 1] * expansionFactor;
                const tz = targetPositions[idx + 2] * expansionFactor;

                // ç®€å•çº¿æ€§æ’å€¼ (Lerp) å®ç°å¹³æ»‘è¿‡æ¸¡
                positions[idx] += (tx - positions[idx]) * state.smoothing;
                positions[idx + 1] += (ty - positions[idx + 1]) * state.smoothing;
                positions[idx + 2] += (tz - positions[idx + 2]) * state.smoothing;
            }

            particles.geometry.attributes.position.needsUpdate = true;
            
            // è®©ç²’å­æœ‰è½»å¾®çš„å‘¼å¸æ„Ÿ/æ—‹è½¬
            particles.rotation.y += 0.001;

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- MediaPipe æ‰‹åŠ¿è¯†åˆ« ---
        async function initMediaPipe() {
            const videoElement = document.getElementById('video-feed');
            
            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});

            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandsResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480
            });

            cameraUtils.start()
                .then(() => {
                    document.getElementById('loader').style.opacity = 0;
                })
                .catch(err => {
                    console.error("Camera error:", err);
                    document.getElementById('loader').innerHTML = "æ— æ³•è®¿é—®æ‘„åƒå¤´<br>è¯·ç¡®ä¿åœ¨HTTPSæˆ–Localhostä¸‹è¿è¡Œ";
                });
        }

        function onHandsResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                
                // ç­–ç•¥ï¼šæ£€æµ‹åŒæ‰‹é£ŸæŒ‡æŒ‡å°–çš„è·ç¦»
                // å¦‚æœåªæœ‰ä¸€åªæ‰‹ï¼Œæ£€æµ‹å¤§æ‹‡æŒ‡å’Œé£ŸæŒ‡çš„è·ç¦»ï¼ˆæåˆï¼‰
                
                let dist = 0;

                if (results.multiHandLandmarks.length === 2) {
                    // åŒæ‰‹æ¨¡å¼ï¼šè®¡ç®—ä¸¤ä¸ªé£ŸæŒ‡æŒ‡å°– (Index Finger Tip is index 8) çš„è·ç¦»
                    const hand1 = results.multiHandLandmarks[0][8];
                    const hand2 = results.multiHandLandmarks[1][8];
                    
                    // è®¡ç®—æ¬§å‡ é‡Œå¾—è·ç¦» (ç®€å•ç‰ˆï¼Œå¿½ç•¥Zæ·±åº¦ä»¥è·å¾—æ›´ç¨³å®šçš„æ§åˆ¶)
                    const dx = hand1.x - hand2.x;
                    const dy = hand1.y - hand2.y;
                    const rawDist = Math.sqrt(dx*dx + dy*dy);
                    
                    // å½’ä¸€åŒ–ï¼šé€šå¸¸åŒæ‰‹å¼ å¼€åœ¨å±å¹•ä¸Šè·ç¦»çº¦ä¸º 0.5 - 0.8
                    // æˆ‘ä»¬æ˜ å°„ 0.1 (è¿‘) åˆ° 0.6 (è¿œ) -> è¾“å‡º 0 åˆ° 1
                    dist = THREE.MathUtils.mapLinear(rawDist, 0.05, 0.6, 0, 1);

                } else if (results.multiHandLandmarks.length === 1) {
                    // å•æ‰‹æ¨¡å¼ï¼šè®¡ç®—æ‹‡æŒ‡(4)å’Œé£ŸæŒ‡(8)çš„è·ç¦»
                    const hand = results.multiHandLandmarks[0];
                    const thumb = hand[4];
                    const index = hand[8];
                    
                    const dx = thumb.x - index.x;
                    const dy = thumb.y - index.y;
                    const rawDist = Math.sqrt(dx*dx + dy*dy);
                    
                    // å•æ‰‹æåˆï¼š0.02 (æä½) -> 0.2 (å¼ å¼€)
                    dist = THREE.MathUtils.mapLinear(rawDist, 0.02, 0.2, 0, 1);
                }

                // é™åˆ¶åœ¨ 0-1 ä¹‹é—´å¹¶å¹³æ»‘å¤„ç†
                dist = THREE.MathUtils.clamp(dist, 0, 1);
                
                // ç®€å•çš„é˜»å°¼æ•ˆæœï¼Œé¿å…æ‰‹æŠ–å¯¼è‡´é—ªçƒ
                state.handDistance += (dist - state.handDistance) * 0.1;
            } else {
                // æ²¡æœ‰æ£€æµ‹åˆ°æ‰‹ï¼Œæ…¢æ…¢å½’é›¶
                state.handDistance += (0 - state.handDistance) * 0.05;
            }
        }

        // --- å¯åŠ¨ç¨‹åº ---
        initThree();
        initMediaPipe();

    </script>
</body>
</html>
